name: Safeline Daily Report

on:
  push:
    branches:
      - main
  schedule:
    # cron è¡¨è¾¾å¼ä½¿ç”¨ UTC æ—¶é—´ã€‚'59 15 * * *' å¯¹åº” UTC 15:59ï¼Œå³åŒ—äº¬æ—¶é—´ 23:59ã€‚
    - cron: '59 15 * * *'

jobs:
  safeline-job:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Fetch WAF Data
        id: fetch_data
        run: |
          # è®¾ç½®ç»Ÿè®¡æ—¶é—´èŒƒå›´ (è¿‡åŽ»24å°æ—¶)
          begin_time=$(date -u -d 'yesterday 16:00:00' +%s)
          end_time=$(date -u -d 'today 15:59:59' +%s)
          report_date=$(date -u -d 'today' +"%Yå¹´%mæœˆ%dæ—¥")
          echo "report_date=${report_date}" >> $GITHUB_ENV
          
          # --- èŽ·å–æ”»å‡»ç»Ÿè®¡ ---
          echo "Fetching attack stats..."
          attack_json=$(curl --fail -s -X GET "${{ secrets.WAF_HOST }}/api/stat/basic/attack" -H "X-SLCE-API-TOKEN: ${{ secrets.WAF_TOKEN }}")
          
          echo "DEBUG: Attack API Response: [${attack_json}]"
          # ä¿®æ­£ï¼šåœ¨ jq æŸ¥è¯¢ä¸­å¢žåŠ  .[0] æ¥å¤„ç†æ•°ç»„ç»“æž„
          if [[ -z "$attack_json" || ! $(echo "$attack_json" | jq -e '.[0].data.intercept' > /dev/null) ]]; then
            echo "::error::Failed to fetch or parse attack stats. Response was empty or invalid."
            exit 1
          fi
          # ä¿®æ­£ï¼šåœ¨æ‰€æœ‰ jq æŸ¥è¯¢ä¸­å¢žåŠ  .[0]
          echo "block=$(echo $attack_json | jq '.[0].data.intercept.block')" >> $GITHUB_ENV
          echo "rate_limit=$(echo $attack_json | jq '.[0].data.intercept.rate_limit')" >> $GITHUB_ENV
          echo "challenge=$(echo $attack_json | jq '.[0].data.intercept.challenge')" >> $GITHUB_ENV
          echo "offline=$(echo $attack_json | jq '.[0].data.intercept.offline')" >> $GITHUB_ENV
          echo "attack_ip=$(echo $attack_json | jq '.[0].data.attack_ip')" >> $GITHUB_ENV

          # --- èŽ·å–é”™è¯¯ç ç»Ÿè®¡ ---
          echo "Fetching error code stats..."
          error_json=$(curl --fail -s -X GET "${{ secrets.WAF_HOST }}/api/stat/basic/error_status_code" -H "X-SLCE-API-TOKEN: ${{ secrets.WAF_TOKEN }}")
          
          echo "DEBUG: Error API Response: [${error_json}]"
          if [[ -z "$error_json" || ! $(echo "$error_json" | jq -e '.data' > /dev/null) ]]; then
            echo "::error::Failed to fetch or parse error stats. Response was empty or invalid."
            exit 1
          fi
          echo "error_4xx=$(echo $error_json | jq '.data.error_4xx')" >> $GITHUB_ENV
          echo "error_5xx=$(echo $error_json | jq '.data.error_5xx')" >> $GITHUB_ENV

          # --- èŽ·å–è®¿é—®ç»Ÿè®¡ ---
          echo "Fetching access stats..."
          access_json=$(curl --fail -s -X GET "${{ secrets.WAF_HOST }}/api/stat/advance/access?begin_time=${begin_time}&end_time=${end_time}" -H "X-SLCE-API-TOKEN: ${{ secrets.WAF_TOKEN }}")
          
          echo "DEBUG: Access API Response: [${access_json}]"
          if [[ -z "$access_json" || ! $(echo "$access_json" | jq -e '.data' > /dev/null) ]]; then
            echo "::error::Failed to fetch or parse access stats. Response was empty or invalid."
            exit 1
          fi
          echo "access=$(echo $access_json | jq '.data.access')" >> $GITHUB_ENV
          echo "session=$(echo $access_json | jq '.data.session')" >> $GITHUB_ENV
          echo "ip=$(echo $access_json | jq '.data.ip')" >> $GITHUB_ENV

      - name: 2. Send Report to Feishu
        run: |
          payload=$(cat <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": { "tag": "plain_text", "content": "ðŸ›¡ï¸ é•¿äº­ WAF æ¯æ—¥å®‰å…¨ç®€æŠ¥ (${{ env.report_date }})" },
                "template": "blue"
              },
              "elements": [
                { "tag": "div", "fields": [
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**æ€»è®¿é—®é‡ (PV):**\n${{ env.access }}" } },
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**ç‹¬ç«‹IPæ•° (UV):**\n${{ env.ip }}" } }
                  ]
                },
                { "tag": "hr" },
                { "tag": "div", "fields": [
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**æ‹¦æˆªæ€»æ•°:**\n${{ env.block }}" } },
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**æ”»å‡»IPæ•°:**\n${{ env.attack_ip }}" } },
                    { "is_short": false, "text": { "tag": "lark_md", "content": "" } },
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**é€ŸçŽ‡é™åˆ¶:** ${{ env.rate_limit }}" } },
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**äººæœºæŒ‘æˆ˜:** ${{ env.challenge }}" } },
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**ç¦»çº¿å°ç¦:** ${{ env.offline }}" } }
                  ]
                },
                { "tag": "hr" },
                { "tag": "div", "fields": [
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**4xx é”™è¯¯æ•°:**\n${{ env.error_4xx }}" } },
                    { "is_short": true, "text": { "tag": "lark_md", "content": "**5xx é”™è¯¯æ•°:**\n${{ env.error_5xx }}" } }
                  ]
                },
                { "tag": "note", "elements": [ { "tag": "plain_text", "content": "æŠ¥å‘Šç”ŸæˆäºŽ: $(date -u) UTC" } ] }
              ]
            }
          }
          EOF
          )
          
          curl -X POST -H "Content-Type: application/json" -d "$payload" ${{ secrets.FEISHU_URL }}