name: Safeline Daily Report

on:
  push:
    branches:
      - main # ä»…åœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  schedule:
    # åŒ—äº¬æ—¶é—´æ¯å¤© 23:59 è¿è¡Œ (UTC 15:59)
    - cron: '59 23 * * *'

jobs:
  safeline-job:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Set Time Range & Fetch Data
        id: fetch_data
        run: |
          # è®¾ç½®ç»Ÿè®¡æ—¶é—´èŒƒå›´ (è¿‡å»24å°æ—¶)
          # æ³¨æ„: GitHub Actions ä½¿ç”¨ UTC æ—¶é—´, cron éœ€è¦ç›¸åº”è°ƒæ•´
          begin_time=$(date -u -d 'yesterday 16:00:00' +%s)
          end_time=$(date -u -d 'today 15:59:59' +%s)
          report_date=$(date -u -d 'today' +"%Yå¹´%mæœˆ%dæ—¥")
          echo "report_date=${report_date}" >> $GITHUB_ENV
          
          # --- è·å–æ”»å‡»ç»Ÿè®¡ ---
          attack_json=$(curl -s -X GET "${{ secrets.WAF_HOST }}/api/stat/basic/attack" -H "X-SLCE-API-TOKEN: ${{ secrets.WAF_TOKEN }}")
          echo "block=$(echo $attack_json | jq '.data.intercept.block')" >> $GITHUB_ENV
          echo "rate_limit=$(echo $attack_json | jq '.data.intercept.rate_limit')" >> $GITHUB_ENV
          echo "challenge=$(echo $attack_json | jq '.data.intercept.challenge')" >> $GITHUB_ENV
          echo "offline=$(echo $attack_json | jq '.data.intercept.offline')" >> $GITHUB_ENV
          echo "attack_ip=$(echo $attack_json | jq '.data.attack_ip')" >> $GITHUB_ENV

          # --- è·å–é”™è¯¯ç ç»Ÿè®¡ ---
          error_json=$(curl -s -X GET "${{ secrets.WAF_HOST }}/api/stat/basic/error_status_code" -H "X-SLCE-API-TOKEN: ${{ secrets.WAF_TOKEN }}")
          echo "error_4xx=$(echo $error_json | jq '.data.error_4xx')" >> $GITHUB_ENV
          echo "error_5xx=$(echo $error_json | jq '.data.error_5xx')" >> $GITHUB_ENV

          # --- è·å–è®¿é—®ç»Ÿè®¡ ---
          access_json=$(curl -s -X GET "${{ secrets.WAF_HOST }}/api/stat/advance/access?begin_time=${begin_time}&end_time=${end_time}" -H "X-SLCE-API-TOKEN: ${{ secrets.WAF_TOKEN }}")
          echo "access=$(echo $access_json | jq '.data.access')" >> $GITHUB_ENV
          echo "session=$(echo $access_json | jq '.data.session')" >> $GITHUB_ENV
          echo "ip=$(echo $access_json | jq '.data.ip')" >> $GITHUB_ENV

      - name: 2. Send Report to Feishu
        run: |
          # ä½¿ç”¨heredocæ„å»ºé£ä¹¦å¡ç‰‡æ¶ˆæ¯JSON, ç®€æ´ä¸”æ— éœ€è½¬ä¹‰
          payload=$(cat <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "ğŸ›¡ï¸ é•¿äº­ WAF æ¯æ—¥å®‰å…¨ç®€æŠ¥ (${{ env.report_date }})"
                },
                "template": "blue"
              },
              "elements": [
                {
                  "tag": "div",
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**æ€»è®¿é—®é‡ (PV):**\n${{ env.access }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ç‹¬ç«‹IPæ•° (UV):**\n${{ env.ip }}"
                      }
                    }
                  ]
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**æ‹¦æˆªæ€»æ•°:**\n${{ env.block }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**æ”»å‡»IPæ•°:**\n${{ env.attack_ip }}"
                      }
                    },
                    {
                      "is_short": false,
                      "text": {
                        "tag": "lark_md",
                        "content": ""
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**é€Ÿç‡é™åˆ¶:** ${{ env.rate_limit }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**äººæœºæŒ‘æˆ˜:** ${{ env.challenge }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ç¦»çº¿å°ç¦:** ${{ env.offline }}"
                      }
                    }
                  ]
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**4xx é”™è¯¯æ•°:**\n${{ env.error_4xx }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**5xx é”™è¯¯æ•°:**\n${{ env.error_5xx }}"
                      }
                    }
                  ]
                },
                {
                  "tag": "note",
                  "elements": [
                    {
                      "tag": "plain_text",
                      "content": "æŠ¥å‘Šç”Ÿæˆäº: $(date -u)"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          )
          
          curl -X POST -H "Content-Type: application/json" \
            -d "$payload" \
            ${{ secrets.FEISHU_URL }}